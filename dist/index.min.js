"use strict";var _typeof2=require("babel-runtime/helpers/typeof"),_typeof3=_interopRequireDefault(_typeof2),_getIterator2=require("babel-runtime/core-js/get-iterator"),_getIterator3=_interopRequireDefault(_getIterator2),_freeze=require("babel-runtime/core-js/object/freeze"),_freeze2=_interopRequireDefault(_freeze),_getOwnPropertyNames=require("babel-runtime/core-js/object/get-own-property-names"),_getOwnPropertyNames2=_interopRequireDefault(_getOwnPropertyNames),_promise=require("babel-runtime/core-js/promise"),_promise2=_interopRequireDefault(_promise),_set=require("babel-runtime/core-js/set"),_set2=_interopRequireDefault(_set),_from=require("babel-runtime/core-js/array/from"),_from2=_interopRequireDefault(_from),_regenerator=require("babel-runtime/regenerator"),_regenerator2=_interopRequireDefault(_regenerator),_asyncToGenerator2=require("babel-runtime/helpers/asyncToGenerator"),_asyncToGenerator3=_interopRequireDefault(_asyncToGenerator2),_assign=require("babel-runtime/core-js/object/assign"),_assign2=_interopRequireDefault(_assign),_slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),replace=function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(b,c,d){var e,f;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:return c.lastIndex=0,e=void 0,f=[],b.replace(c,function(a){for(var b=arguments.length,c=Array(1<b?b-1:0),e=1;e<b;e++)c[e-1]=arguments[e];var g=d.apply(void 0,[a].concat(c));f.push(g)}),a.next=5,_promise2.default.all(f);case 5:return e=a.sent,a.abrupt("return",e.length?b.replace(c,function(){return e.shift()}):b);case 7:case"end":return a.stop();}},a,this)}));return function(){return a.apply(this,arguments)}}();function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}var fs=require("fs"),path=require("path"),crypto=require("crypto"),loaderUtils=require("loader-utils"),validateOptions=require("schema-utils"),SVGO=require("svgo"),DEFAULT_OPTIONS=freeze({inline:{keyword:"svg-inline",strict:!0},sprite:{keyword:"svg-sprite",strict:!0},removeAttributes:["alt","src"],md5:!1,xhtml:!1,svgo:{plugins:[{cleanupAttrs:!0}]}}),DEFAULT_OPTIONS_SCHEMA=freeze({type:"object",properties:{inline:{type:"object",properties:{keyword:{type:"string"},strict:{type:"boolean"}},additionalProperties:!1},sprite:{type:"object",properties:{keyword:{type:"string"},strict:{type:"boolean"}},additionalProperties:!1},removeAttributes:{type:"array"},md5:{type:"boolean"},xhtml:{type:"boolean"},svgo:{type:"object",properties:{plugins:{type:"array"}},additionalProperties:!1}},additionalProperties:!1}),PATTERN_VUE_SFC_HTML=/^\s*<template(?:\s+[^>]*lang[\s="']+html["'][^>]*)?>\s*/i,PATTERN_TEMPLATE_ROOT_OPEN_TAG=/(<template(?:\s+[^>]*lang[\s="']+html["'][^>]*)?>\s*<[\s\S]+?>)([\s\S]*<\/template>)/i,PATTERN_IMAGE_SRC_SVG=/<img\s+[^>]*src[\s="']+([^"']+\.svg)(?:[\?#][^"']*)?["'][^>]*\/?>/gi,PATTERN_SVG_CONTENT=/(<svg[^>]*>)([\s\S]*)(<\/svg>)/i,PATTERN_SVG_OPEN_TAG=/^<svg/i,PATTERN_ATTRIBUTES=/\s*([:@]?[^\s=]+)[\s=]+(?:"([^"]*)"|'([^']*)')?\s*/g,PATTERN_ATTRIBUTE_NAME=/^[:@]?[a-z][a-z-]+[a-z]$/i,PATTERN_WHITESPACES=/\s+/g,PATTERN_TAG=/^<|>$/,PATTERN_DEPRECATED_OPTION=/^(inline|sprite)(keyword|strict)$/i;module.exports=function(a){var b=this;this.cacheable&&this.cacheable();var c=this.async(),d=loaderUtils.getOptions(this)||{};(0,_keys2.default)(d).forEach(function(a){if(PATTERN_DEPRECATED_OPTION.test(a)){var b=d[a],c=a.toLowerCase().match(PATTERN_DEPRECATED_OPTION);c.shift();var e=(0,_slicedToArray3.default)(c,2),f=e[0],g=e[1];d[f]=d[f]||{},d[f][g]=b,delete d[a]}});var e=(0,_assign2.default)({},DEFAULT_OPTIONS,d);e.removeAttributes=e.removeAttributes.map(function(a){return a.toLowerCase()}),validateOptions(DEFAULT_OPTIONS_SCHEMA,e,"vue-svg-inline-loader"),e._sprites=".vue"===path.extname(this.resourcePath).toLowerCase()&&PATTERN_VUE_SFC_HTML.test(a),[e.inline.keyword,e.sprite.keyword].forEach(function(a){if(!PATTERN_ATTRIBUTE_NAME.test(a))throw new Error("Keyword "+a+" is not valid.")});var f=new RegExp("\\s+(?:data-)?"+e.inline.keyword+"\\s+","i"),g=new RegExp("\\s+(?:data-)?"+e.sprite.keyword+"\\s+","i"),h=new SVGO(e.svgo),i=[];replace(a,PATTERN_IMAGE_SRC_SVG,function(){var a=(0,_asyncToGenerator3.default)(_regenerator2.default.mark(function a(c,d){var j,k,l,m;return _regenerator2.default.wrap(function(a){for(;;)switch(a.prev=a.next){case 0:if(!e.inline.strict||f.test(c)){a.next=2;break}return a.abrupt("return",c);case 2:j={path:loaderUtils.urlToRequest(path.join(b.context,d),"/")},b.addDependency(path.normalize(j.path)),a.prev=4,j.content=fs.readFileSync(j.path,{encoding:"utf-8"}),a.next=11;break;case 8:throw a.prev=8,a.t0=a["catch"](4),new Error("File "+j.path+" does not exist.");case 11:return a.prev=11,a.next=14,h.optimize(j.content,{path:j.path});case 14:if(a.t1=a.sent.data,a.t1){a.next=17;break}a.t1=j.content;case 17:j.content=a.t1,a.next=23;break;case 20:throw a.prev=20,a.t2=a["catch"](11),new Error("SVGO for "+j.path+" failed.");case 23:if(PATTERN_SVG_CONTENT.test(j.content)){a.next=25;break}throw new Error("File "+j.path+" is empty.");case 25:for(e._sprites&&(!e.sprite.strict||g.test(c))&&(j.content=j.content.replace(PATTERN_SVG_CONTENT,function(a,b,c,d){var f=[e.sprite.keyword,e.md5?crypto.createHash("md5").update(j.path).digest("hex"):path.basename(j.path,".svg")].join("-");return i.push("<symbol id=\""+f+"\">"+c+"</symbol>"),b+"<use xlink:href=\"#"+f+"\"></use>"+d})),k=void 0,l=[];k=PATTERN_ATTRIBUTES.exec(c);)k.index===PATTERN_ATTRIBUTES.lastIndex&&PATTERN_ATTRIBUTES.lastIndex++,k[1]&&!PATTERN_TAG.test(k[1])&&PATTERN_ATTRIBUTE_NAME.test(k[1])&&l.push({key:k[1],value:k[2]?k[2]:e.xhtml?k[1]:""});return PATTERN_ATTRIBUTES.lastIndex=0,m=l.map(function(a){return a.key.toLowerCase()}),m.includes("role")||l.push({key:"role",value:"presentation"}),m.includes("focusable")||l.push({key:"focusable",value:"false"}),a.abrupt("return",j.content.replace(PATTERN_SVG_OPEN_TAG,"$& "+l.map(function(a){return e.removeAttributes.includes(a.key.toLowerCase())?"":a.key+"=\""+a.value+"\""}).join(" ").replace(PATTERN_WHITESPACES," ")));case 33:case"end":return a.stop();}},a,b,[[4,8],[11,20]])}));return function(){return a.apply(this,arguments)}}()).then(function(a){return e._sprites&&i.length?(i=(0,_from2.default)(new _set2.default(i)),i.unshift("<div style=\"display: none !important;\"><svg><symbols>"),i.push("</symbols></svg></div>"),c(null,a.replace(PATTERN_TEMPLATE_ROOT_OPEN_TAG,"$1"+i.join("")+"$2"))):c(null,a)}).catch(function(a){return c(a)})};function freeze(a){var b=(0,_getOwnPropertyNames2.default)(a),c=!0,d=!1,e=void 0;try{for(var f,g=(0,_getIterator3.default)(b);!(c=(f=g.next()).done);c=!0){var h=f.value,i=a[h];a[h]=i&&"object"===("undefined"==typeof i?"undefined":(0,_typeof3.default)(i))?freeze(i):i}}catch(a){d=!0,e=a}finally{try{!c&&g.return&&g.return()}finally{if(d)throw e}}return(0,_freeze2.default)(a)}
