"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof"));require("core-js/modules/es6.object.freeze");var _slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));require("core-js/modules/es6.regexp.match");require("core-js/modules/es6.function.name");require("core-js/modules/es7.symbol.async-iterator");require("core-js/modules/es6.symbol");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));require("core-js/modules/es7.array.includes");require("core-js/modules/es6.string.includes");var _toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));require("core-js/modules/es6.map");require("core-js/modules/es6.regexp.replace");require("core-js/modules/es6.promise");require("regenerator-runtime/runtime");var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));require("core-js/modules/web.dom.iterable");require("core-js/modules/es6.array.iterator");require("core-js/modules/es6.string.iterator");require("core-js/modules/es6.set");require("core-js/modules/es6.regexp.constructor");require("core-js/modules/es6.array.map");require("core-js/modules/es6.object.assign");var fs=require("fs");var path=require("path");var crypto=require("crypto");var loaderUtils=require("loader-utils");var validateOptions=require("schema-utils");var SVGO=require("svgo");var DEFAULT_OPTIONS=freeze({inline:{keyword:"svg-inline",strict:true},sprite:{keyword:"svg-sprite",strict:true},removeAttributes:["alt","src"],md5:false,xhtml:false,svgo:{plugins:[{cleanupAttrs:true}]}});var DEFAULT_OPTIONS_SCHEMA=freeze({type:"object",properties:{inline:{type:"object",properties:{keyword:{type:"string"},strict:{type:"boolean"}},additionalProperties:false},sprite:{type:"object",properties:{keyword:{type:"string"},strict:{type:"boolean"}},additionalProperties:false},removeAttributes:{type:"array"},md5:{type:"boolean"},xhtml:{type:"boolean"},svgo:{type:"object",properties:{plugins:{type:"array"}},additionalProperties:false}},additionalProperties:false});var PATTERN_VUE_SFC_HTML=/^\s*<template(?:\s+[^>]*lang[\s="']+html["'][^>]*)?>\s*/i;var PATTERN_TEMPLATE_ROOT_OPEN_TAG=/(<template(?:\s+[^>]*lang[\s="']+html["'][^>]*)?>\s*<[\s\S]+?>)([\s\S]*<\/template>)/i;var PATTERN_IMAGE_SRC_SVG=/<img\s+[^>]*src[\s="']+([^"']+\.svg)(?:[\?#][^"']*)?["'][^>]*\/?>/gi;var PATTERN_SVG_CONTENT=/(<svg[^>]*>)([\s\S]*)(<\/svg>)/i;var PATTERN_SVG_OPEN_TAG=/^<svg/i;var PATTERN_ATTRIBUTES=/\s*([:@]?[^\s=]+)[\s=]+(?:"([^"]*)"|'([^']*)')?\s*/g;var PATTERN_ATTRIBUTE_NAME=/^[:@]?[a-z][a-z-]+[a-z]$/i;var PATTERN_TAG=/^<|>$/;var PATTERN_DEPRECATED_OPTION=/^(inline|sprite)(keyword|strict)$/i;module.exports=function(content){var _this=this;this.cacheable&&this.cacheable();var callback=this.async();var loaderOptions=loaderUtils.getOptions(this)||{};var loaderOptionsPropNames=Object.getOwnPropertyNames(loaderOptions);var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=loaderOptionsPropNames[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var name=_step.value;if(PATTERN_DEPRECATED_OPTION.test(name)){var value=loaderOptions[name];var matches=name.toLowerCase().match(PATTERN_DEPRECATED_OPTION);var _matches$slice=matches.slice(1),_matches$slice2=(0,_slicedToArray2.default)(_matches$slice,2),match1=_matches$slice2[0],match2=_matches$slice2[1];loaderOptions[match1]=loaderOptions[match1]||{};loaderOptions[match1][match2]=loaderOptions[match1][match2]||value;delete loaderOptions[name]}}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return!=null){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}};var options=Object.assign({},DEFAULT_OPTIONS,loaderOptions);options.removeAttributes=options.removeAttributes.map(function(attribute){return attribute.toLowerCase()});validateOptions(DEFAULT_OPTIONS_SCHEMA,options,"vue-svg-inline-loader");options._sprites=path.extname(this.resourcePath).toLowerCase()===".vue"&&PATTERN_VUE_SFC_HTML.test(content);var _arr=[options.inline.keyword,options.sprite.keyword];for(var _i=0;_i<_arr.length;_i++){var keyword=_arr[_i];if(!PATTERN_ATTRIBUTE_NAME.test(keyword)){throw new Error("Keyword ".concat(keyword," is not valid."))}}var PATTERN_INLINE_KEYWORD=new RegExp("\\s+(?:data-)?".concat(options.inline.keyword,"\\s+"),"i");var PATTERN_SPRITE_KEYWORD=new RegExp("\\s+(?:data-)?".concat(options.sprite.keyword,"\\s+"),"i");var svgo=new SVGO(options.svgo);var symbols=new Set;replace(content,PATTERN_IMAGE_SRC_SVG,function(){var _ref=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(image,source){var filePath,file,attributes,attribute;return _regenerator.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(options.inline.strict&&!PATTERN_INLINE_KEYWORD.test(image))){_context.next=2;break}return _context.abrupt("return",image);case 2:_context.next=4;return new Promise(function(resolve,reject){_this.resolve(_this.context,source,function(error,resolvedPath){if(error)reject(error);else resolve(resolvedPath)})});case 4:filePath=_context.sent;file={path:filePath};_this.addDependency(path.normalize(file.path));_context.prev=7;file.content=fs.readFileSync(file.path,{encoding:"utf-8"});_context.next=14;break;case 11:_context.prev=11;_context.t0=_context["catch"](7);throw new Error("File ".concat(file.path," does not exist."));case 14:_context.prev=14;_context.next=17;return svgo.optimize(file.content,{path:file.path});case 17:_context.t1=_context.sent.data;if(_context.t1){_context.next=20;break}_context.t1=file.content;case 20:file.content=_context.t1;_context.next=26;break;case 23:_context.prev=23;_context.t2=_context["catch"](14);throw new Error("SVGO for ".concat(file.path," failed."));case 26:if(PATTERN_SVG_CONTENT.test(file.content)){_context.next=28;break}throw new Error("File ".concat(file.path," is empty."));case 28:if(options._sprites&&(!options.sprite.strict||PATTERN_SPRITE_KEYWORD.test(image))){file.content=file.content.replace(PATTERN_SVG_CONTENT,function(svg,svgOpenTag,symbol,svgCloseTag){var id=[options.sprite.keyword,options.md5?crypto.createHash("md5").update(file.path).digest("hex"):path.basename(file.path,".svg")].join("-");symbols.add("<symbol id=\"".concat(id,"\">").concat(symbol,"</symbol>"));return"".concat(svgOpenTag,"<use xlink:href=\"#").concat(id,"\"></use>").concat(svgCloseTag)})}attributes=new Map;while(attribute=PATTERN_ATTRIBUTES.exec(image)){if(attribute.index===PATTERN_ATTRIBUTES.lastIndex){PATTERN_ATTRIBUTES.lastIndex++}if(attribute[1]&&!PATTERN_TAG.test(attribute[1])&&PATTERN_ATTRIBUTE_NAME.test(attribute[1])){attributes.set(attribute[1].toLowerCase(),attribute[2]?attribute[2]:(options.xhtml?attribute[1]:"").toLowerCase())}}PATTERN_ATTRIBUTES.lastIndex=0;if(!attributes.has("role")){attributes.set("role","presentation")}if(!attributes.has("focusable")){attributes.set("focusable","false")}return _context.abrupt("return",attributes.size?file.content.replace(PATTERN_SVG_OPEN_TAG,"$& "+(0,_toConsumableArray2.default)(attributes.keys()).map(function(attribute){return!options.removeAttributes.includes(attribute)?"".concat(attribute,"=\"").concat(attributes.get(attribute).toLowerCase(),"\""):""}).join(" ")):file.content);case 35:case"end":return _context.stop();}}},_callee,this,[[7,11],[14,23]])}));return function(_x,_x2){return _ref.apply(this,arguments)}}()).then(function(content){return callback(null,options._sprites&&symbols.size?content.replace(PATTERN_TEMPLATE_ROOT_OPEN_TAG,"$1<div style=\"display: none !important;\"><svg><symbols>".concat((0,_toConsumableArray2.default)(symbols).join(""),"</symbols></svg></div>$2")):content)}).catch(function(error){return callback(error)})};function replace(_x3,_x4,_x5){return _replace.apply(this,arguments)}function _replace(){_replace=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee2(string,regex,callback){var promises,data;return _regenerator.default.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:regex.lastIndex=0;promises=[];string.replace(regex,function(match){for(var _len=arguments.length,args=new Array(_len>1?_len-1:0),_key=1;_key<_len;_key++){args[_key-1]=arguments[_key]}var promise=callback.apply(void 0,[match].concat(args));promises.push(promise)});_context2.next=5;return Promise.all(promises);case 5:data=_context2.sent;return _context2.abrupt("return",data.length?string.replace(regex,function(){return data.shift()}):string);case 7:case"end":return _context2.stop();}}},_callee2,this)}));return _replace.apply(this,arguments)}function freeze(object){var propNames=Object.getOwnPropertyNames(object);var _iteratorNormalCompletion2=true;var _didIteratorError2=false;var _iteratorError2=undefined;try{for(var _iterator2=propNames[Symbol.iterator](),_step2;!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=true){var name=_step2.value;var value=object[name];object[name]=value&&(0,_typeof2.default)(value)==="object"?freeze(value):value}}catch(err){_didIteratorError2=true;_iteratorError2=err}finally{try{if(!_iteratorNormalCompletion2&&_iterator2.return!=null){_iterator2.return()}}finally{if(_didIteratorError2){throw _iteratorError2}}}return Object.freeze(object)}
